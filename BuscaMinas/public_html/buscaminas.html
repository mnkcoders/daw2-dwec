<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link href="https://fonts.googleapis.com/css?family=Exo:100,200,300,400,500,600,700,800,900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.css" type="text/css" rel="stylesheet" />
    
        <style type="text/css">
            body{
                
            }
            #chuscaminas:after{
                content: '';
                display: block;
                clear: both;
                height: 0;
            }
            #chuscaminas > .celda{
                box-sizing: border-box;
                display: inline-block;
                float: left;
                height: 100px;
                border: 1px solid rgba(0,0,0,0.25);
                transition: 250ms ease-in;
            }
            #chuscaminas > .celda.show{
                background-color: rgba(128,128,224,0.25);
            }
            #chuscaminas > .celda.show.mine{
                background-color: rgba(224,128,128,0.5);
            }
            #chuscaminas > .celda:hover{
                background-color: rgba(0,0,0,0.2);
            }
            #chuscaminas.grid-8 > .celda{
                width: 12.5%;
            }
        </style>
    </head>
    <body>
        <div id="chuscaminas" class="container">
            
        </div>
        
        <script type="text/javascript">
            /**
             * 
             * @returns {BuscaMinas}
             */
            function BuscaMinas( columnas , filas ){
                
                var _BM = {
                    /**
                     * @type Array
                     */
                    'celdas': [],
                    'tablero':{
                        'rows': filas || 8,
                        'cols': columnas || 8,
                        'minas': 0
                    },
                    /**
                     * @type Int
                     */
                    'status': BuscaMinas.Estado.Iniciado
                };
                /**
                 * @returns {Number}
                 */
                this.estado = () => _BM.status;
                /**
                 * @returns {Object}
                 */
                this.tablero = () => _BM.tablero;
                /**
                 * @param {Number} id
                 * @returns {Number|Boolean}
                 */
                this.getUp = function( id ){
                    
                    return id > _BM.tablero.cols - 1 ? id - _BM.tablero.cols : false;
                };
                /**
                 * @param {Number} id
                 * @returns {Number|Boolean}
                 */
                this.getDown = function( id ){

                    return parseInt( id / _BM.tablero.cols ) < ( _BM.tablero.rows - 1 ) ?
                         id + _BM.tablero.cols :
                                false;
                };
                /**
                 * @param {Number} id
                 * @returns {Boolean|_BM.celdas}
                 */
                this.getLeft = function( id ){
                    
                    return id % _BM.tablero.cols > 0 ? id - 1: false;
                };
                /**
                 * @param {Number} id
                 * @returns {Boolean|_BM.celdas}
                 */
                this.getRight = function( id ){
                    
                    return id % _BM.tablero.cols < _BM.tablero.cols - 2 ? id + 1 : false;
                };
                /**
                 * @param {Int} id
                 * @returns {Boolean}
                 */
                this.activar = function( id ){
                   
                    if( this.explorar( id ) ){
                            _BM.status = BuscaMinas.Estado.Perdido;
                            return true;
                    }
                    false;
                };
                /**
                 * @param {type} id
                 * @returns {Boolean}
                 */
                this.explorar = function( id ){
                    
                    return id >= 0 && id < _BM.celdas.length ?
                        _BM.celdas[ id ] :
                                false;
                };
                /**
                 * Revela celdas adjuntas
                 * @param {Number} x
                 * @param {Number} y
                 * @returns {Number}
                 */
                this.revelar = function( x , y ){
                    
                    return this.explorar( ( y * _BM.tablero.cols ) + x );
                };
                /**
                 * @returns {Boolean[]}
                 */
                this.celdas = function(){
                    return _BM.celdas;
                };
                /**
                 * 
                 * @returns {BuscaMinas}
                 */
                this.reset = function( cols , rows ){
                    
                    _BM.status = BuscaMinas.Estado.Iniciado;
                    
                    var C = cols || _BM.tablero.cols;
                    var R = rows || _BM.tablero.rows;
                    
                    var N = C * R;
                    var M = N / 4;
                    _BM.tablero.minas = M;
                    
                    for( var i = 0 ; i < N ; i++ ){
                        
                        var mina = M > 0 && parseInt( Math.random() * 5 ) > 3;
                        
                        _BM.celdas.push( mina );
                        
                        if( mina ){
                            M--;
                        }
                    }
                    
                    return this;
                };
                
                return this.reset();
            };
            
            BuscaMinas.Estado = {
                'Iniciado':0,
                'Jugando':1,
                'Ganado':2,
                'Perdido':3
            };
            
            
            ( function(){
                
                var _GAME = {
                    'this': this,
                    /**
                     * 
                     * @returns {BuscaMinas}
                     */
                    'logica': new BuscaMinas()
                };
                /**
                 * Mostrar la celda en el tablero
                 * @param {Number} id
                 * @returns {indexL#137}
                 */
                this.descubrir = function( id , mine ){
                   
                    document.getElementById( 'id-' + id ).classList.add( 'show' );

                    if( mine ){
                        document.getElementById( 'id-' + id ).classList.add( 'mine' );
                    }
                    
                    return this;
                };
                /**
                 * 
                 * @param {Number} id
                 * @returns {indexL#137}
                 */
                this.activar = function( id ){
   
                    console.log( 'Activando ' + id );
                    
                    if( _GAME.logica.activar( id ) ){
                        
                        console.log(' KABUM!!');
                        this.descubrir( id , true );
                    }
                    else{
                        //no hay mina!
                        this.descubrir( id );
                        //explorar alrededor!
                        var up = _GAME.logica.getUp( id );
                        var down = _GAME.logica.getDown( id );
                        var left = _GAME.logica.getLeft( id );
                        var right = _GAME.logica.getRight( id );
                        if( up !== false ){
                            //descrubrir mina encima
                            this.descubrir( up ,  _GAME.logica.explorar( up ) );
                        }
                        if( down !== false ){
                            //descrubrir mina debajo
                            this.descubrir( down ,  _GAME.logica.explorar( down ) );
                        }
                        if( left !== false ){
                            //descrubrir mina iqzuierda
                            this.descubrir( left ,  _GAME.logica.explorar( left ) );
                        }
                        if( right !== false ){
                            //descrubrir mina encima
                            this.descubrir( right ,  _GAME.logica.explorar( right ) );
                        }
                    }
                    
                    return this;
                };
                /**
                 * 
                 * @returns {indexL#14}
                 */
                this.init = function(){
                    
                    var C = document.getElementById('chuscaminas');
                    C.className = 'container grid-' + _GAME.logica.tablero().cols;
                    var celdas = _GAME.logica.celdas();
                    
                    for( var c = 0 ; c < celdas.length ; c++ ){
                        
                        var celda = document.createElement('span');
                        celda.className = 'celda';
                        celda.setAttribute('data-id',c);
                        celda.id = 'id-' + c;
                        celda.addEventListener( 'click', function( e ) {
                            e.preventDefault();
                            _GAME.this.activar( parseInt( this.getAttribute('data-id') ) );
                            
                            switch( _GAME.logica.estado() ){
                                case BuscaMinas.Estado.Ganado:
                                    alert('Has Ganado!!');
                                    break;
                                case BuscaMinas.Estado.Perdido:
                                    alert('Has Perdido!!');
                                    break;
                            }
                            return true;
                        });
                        
                        C.appendChild( celda );
                        
                    }
                    
                    console.log( _GAME.logica.celdas() );
                    
                    return this;
                };
                
                return this.init();
            })();
            
            
        </script>
    </body>
</html>
